<ion-header>
  <ion-toolbar>
    <div class="header-right">
      <span class="clock">{{ currentHourMinute }}</span>
      <svg class="progress-circle" viewBox="0 0 36 36">
        <path
          class="circle-bg"
          d="M18 2.0845
             a 15.9155 15.9155 0 0 1 0 31.831
             a 15.9155 15.9155 0 0 1 0 -31.831"
        />
        <path
          class="circle"
          [attr.stroke-dasharray]="progress + ', 100'"
          d="M18 2.0845
             a 15.9155 15.9155 0 0 1 0 31.831
             a 15.9155 15.9155 0 0 1 0 -31.831"
        />
        <text x="18" y="20.35" class="timer-text">{{ refreshTime }}</text>
      </svg>
    </div>
  </ion-toolbar>
</ion-header>

<ion-content>
  <div *ngIf="isLoading" class="loading-indicator">
    <p>Loading data, please wait...</p>
  </div>

  <div *ngIf="!isLoading" class="widget-container">
    <div class="widget">
      <h2 class="widget-heading"><ion-icon name="trophy-outline"></ion-icon> Standings</h2>
      <ion-searchbar
        [(ngModel)]="searchQuery"
        placeholder="Search by table heading"
        (ionInput)="onSearch($event)"
      ></ion-searchbar>
      <div class="table-container" [class.auto-scroll]="!isSearching">
        <ng-container *ngFor="let table of filteredTables">
          <table class="ranking-table">
            <thead>
              <tr>
                <th colspan="3">{{ table.heading }}</th>
              </tr>
              <tr>
                <th>Rank</th>
                <th>Player</th>
                <th>Score</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let row of table.data">
                <td>{{ row.rank }}</td>
                <td>{{ row.player }}</td>
                <td>{{ formatNumberWithSeparators(row.score) }}</td>
              </tr>
            </tbody>
          </table>
        </ng-container>
      </div>
    </div>

    <div class="widget">
      <h2 class="widget-heading"><ion-icon name="calendar-outline"></ion-icon> Season</h2>
      <table class="ranking-table">
        <thead>
          <tr>
            <th>Rank</th>
            <th>Player</th>
            <th>Total Points</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let score of highScores">
            <td>{{ score.rank }}</td>
            <td>{{ players[score.player] || score.player }}</td>
            <td>{{ formatNumberWithSeparators(score.total_points) }}</td>
          </tr>
        </tbody>
      </table>
    </div>

    <div class="widget">
      <h2 class="widget-heading"><ion-icon name="time-outline"></ion-icon> Latest Scores</h2>
      <table class="ranking-table">
        <thead>
          <tr>
            <th></th> <!-- New column for medals -->
            <th>Player</th>
            <th>Pinball</th>
            <th>Score</th>
            <th>Rank</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let score of latestScores">
            <td>
              <span *ngIf="score.rank === 1">ðŸ¥‡</span>
              <span *ngIf="score.rank === 2">ðŸ¥ˆ</span>
              <span *ngIf="score.rank === 3">ðŸ¥‰</span>
            </td>
            <td>{{ formatPlayerName(players[score.player] || score.player) }}</td>
            <td>{{ pinballs[score.pinball] || score.pinball }}</td>
            <td>{{ formatNumberWithSeparators(score.points) }}</td>
            <td>{{ score.rank !== null ? score.rank : '-' }}</td>
          </tr>
        </tbody>
      </table>
    </div>

    <div class="widget match-suggestor-widget">
      <h2 class="widget-heading">
        <ion-icon name="color-wand-outline"></ion-icon> Match-Suggester
      </h2>

      <div class="player-selection">
        <div class="dropdown-container">
          <ion-select
            placeholder="Select Player 1"
            [(ngModel)]="selectedPlayer1"
            (ionChange)="checkMatch()"
          >
            <ion-select-option
              *ngFor="let player of playerList"
              [value]="player.abbreviation"
            >
              {{ player.name }}
            </ion-select-option>
          </ion-select>
    
          <ion-select
            placeholder="Select Player 2"
            [(ngModel)]="selectedPlayer2"
            (ionChange)="checkMatch()"
          >
            <ion-select-option
              *ngFor="let player of playerList"
              [value]="player.abbreviation"
            >
              {{ player.name }}
            </ion-select-option>
          </ion-select>
    
          <!-- Reset button with icon -->
          <ion-button (click)="resetSelections()" fill="clear">
            <ion-icon name="refresh-circle-outline" slot="icon-only"></ion-icon>
          </ion-button>
        </div>
      </div>
      <div class="match-suggestor-container">
        <!-- Display message if no players are selected -->
        <div *ngIf="!selectedPlayer1 || !selectedPlayer2" class="no-selection">
          <ion-icon name="arrow-up-outline" style="color: gray; font-size: 2em;"></ion-icon>
          <p style="color: gray;">Please choose player</p>
        </div>
        <!-- Display sad smiley if there are no matches -->
        <div *ngIf="selectedPlayer1 && selectedPlayer2 && matchSuggestions.length === 0" class="no-matches">
          <ion-icon name="sad-outline" style="color: gray; font-size: 2em;"></ion-icon>
          <p style="color: gray;">No matches</p>
        </div>
        <!-- Match suggestions -->
        <div *ngFor="let suggestion of matchSuggestions" class="pinball-group">
          <div class="pinball-row">
            <div class="pinball-name">
              <h3>{{ suggestion.pinballName }}</h3>
            </div>
            <div class="suggestion-list">
              <table class="ranking-table">
                <tbody>
                  <tr *ngFor="let match of suggestion.matches">
                    <td>
                      {{ match.player1 }} / {{ match.player2 }}
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
        <div class="free-scores">
          <h2 class="widget-heading">
            <ion-icon name="bar-chart-outline"></ion-icon> Point-Suggestor
          </h2>
          <ul>
            <div class="info-text">
              <ion-icon name="information-circle-outline"></ion-icon>
              Each game will score (less scores then points)
            </div>
            <li *ngFor="let machine of freeScoreMachines">{{ machine }}</li>
          </ul>
        </div>
      </div>
    </div>